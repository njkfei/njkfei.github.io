title: 图片服务
date: 2016.05.05
categories:  #分类
tags: [java,liux,ImageMagick,image]
---
  图片服务是电商网站的基本服务。你打开XXX网站，进入列表页，看到的是商品的缩略图。
  进入详情页，还在大一点缩略图。你点击一下缩略图，完整的图片最终出来了。

  这里涉及几个方面：
 * 图片压缩
 * 图片裁剪
这可以通过基本工具imagemagick完成。通过springboot封装，对外提供图片服务。

## imagemaick安装
 imagemaick是图片工具套装，提供了一系列图片工具。
 centos下安装，如下所示。
```
 sudo yum install ImageMagick
```
安装完成后，看看能不能用。
```
[XXXXX@iZ28h3eaiotZ ~]$ identify 
Version: ImageMagick 6.7.2-7 2015-07-23 Q16 http://www.imagemagick.org
```
安装正常。

### 图片属性查看

`identity`是检查图片规格命令。如下所示：
```
[XXX@iZ28h3eaiotZ imageprocess]$ identify 109.jpg 
109.jpg JPEG 1280x720 1280x720+0+0 8-bit DirectClass 932KB 0.000u 0:00.000
```
如果想获取详情信息，则可使用如下的命令，

```
[XXX@iZ28h3eaiotZ imageprocess]$ identify -verbose 109.jpg
Image: 109.qua.jpg
  Format: JPEG (Joint Photographic Experts Group JFIF format)
  Class: DirectClass
  Geometry: 1280x720+0+0
  Resolution: 72x72
  Print size: 17.7778x10
  Units: PixelsPerInch
  Type: TrueColor
  Endianess: Undefined
  Colorspace: RGB
  Depth: 8-bit
  Channel depth:
    red: 8-bit
    green: 8-bit
    blue: 8-bit
  Channel statistics:
    Red:
      min: 2 (0.00784314)
      max: 255 (1)
      mean: 115.585 (0.453275)
      standard deviation: 73.6479 (0.288815)
      kurtosis: -1.39492
      skewness: 0.260383
    Green:
      min: 0 (0)
      max: 255 (1)
      mean: 83.8793 (0.328938)
      standard deviation: 73.3303 (0.28757)
      kurtosis: -1.03342
      skewness: 0.703249
    Blue:
      min: 0 (0)
      max: 255 (1)
      mean: 85.1687 (0.333995)
      standard deviation: 66.1706 (0.259493)
      kurtosis: -0.658683
      skewness: 0.836668
  Image statistics:
    Overall:
      min: 0 (0)
      max: 255 (1)
      mean: 94.8777 (0.372069)
      standard deviation: 71.1334 (0.278955)
      kurtosis: -0.962282
      skewness: 0.613406
  Rendering intent: Undefined
  Interlace: None
  Background color: white
  Border color: rgb(223,223,223)
  Matte color: grey74
  Transparent color: black
  Compose: Over
  Page geometry: 1280x720+0+0
  Dispose: Undefined
  Iterations: 0
  Compression: JPEG
  Quality: 70
  Orientation: Undefined
  Properties:
    comment: Lavc55.56.107
    date:create: 2016-05-05T17:18:48+08:00
    date:modify: 2016-05-05T17:18:48+08:00
    jpeg:colorspace: 2
    jpeg:sampling-factor: 2x2,1x1,1x1
    signature: ce1eb774989d8953cc1906cb7f1c0278b6741d47d26c6b42f9f341c25d1fc6a8
  Artifacts:
    verbose: true
  Tainted: False
  Filesize: 50.6KBB
  Number pixels: 922KB
  Pixels per second: 46.08MB
  User time: 0.000u
  Elapsed time: 0:01.019
```

### 图片裁剪
用于剪裁图像的工具是convert。使用“-crop”选项后，convert命令会在输入图像中剪裁出一个矩形区域。
如下所示：

```
[xxx@iZ28h3eaiotZ imageprocess]$ convert 109.jpg -crop 1280x720+20+10 109.crop.jpg 
[xxx@iZ28h3eaiotZ imageprocess]$ ls
109.crop.jpg  109.jpg
```

### 图片压缩
#### 按大小压缩
`-adaptive-resize`选项用于压缩图片，后面跟压缩后的分辩率。
如下所示 。将1280x720的图片压缩为640*480.

```
[xxx@iZ28h3eaiotZ imageprocess]$ convert 109.jpg  -adaptive-resize 640x480 109.small.jpg
[xxx@iZ28h3eaiotZ imageprocess]$ ls
109.crop.jpg  109.jpg  109.small.jpg
```

直接使用'-resize'选项也可以达到上述效果。


#### 按比率压缩
`-resize` 可以指定比率进行压缩，如下所示。
```
[xxx@iZ28h3eaiotZ imageprocess]$ convert 109.jpg  -resize 50%x50% 109.rate.jpg
[xxx@iZ28h3eaiotZ imageprocess]$ ls -lsh
total 1.1M
 80K -rw-rw-r-- 1 xxxx xxxx  77K May  5 11:53 109.crop.jpg
912K -rw-r--r-- 1 xxxx xxxx 911K Apr 21 10:28 109.jpg
 32K -rw-rw-r-- 1 xxxx xxxx  29K May  5 16:18 109.rate.jpg
 32K -rw-rw-r-- 1 xxxx xxxx  29K May  5 12:00 109.small.jpg
```

如果需要设置图片质量，还可以继续压缩，如下所示。
```
[xxxx@iZ28h3eaiotZ imageprocess]$ convert 109.jpg  -resize 50%x50%  -quality 50 109.rate.jpg 
[xxxx@iZ28h3eaiotZ imageprocess]$ sz 109.rate.jpg 
rz
Starting zmodem transfer.  Press Ctrl+C to cancel.
Transferring 109.rate.jpg...
  100%      17 KB      17 KB/sec    00:00:01       0 Errors  

一般指定图片质量为70到80就行，一般看不出来。

[xxxx@iZ28h3eaiotZ imageprocess]$ ls -lsh
total 1.1M
 80K -rw-rw-r-- 1 xxxx xxxx  77K May  5 11:53 109.crop.jpg
912K -rw-r--r-- 1 xxxx xxxx 911K Apr 21 10:28 109.jpg
 20K -rw-rw-r-- 1 xxxx xxxx  18K May  5 16:20 109.rate.jpg
 32K -rw-rw-r-- 1 xxxx xxxx  29K May  5 12:00 109.small.jpg
[xxxx@iZ28h3eaiotZ imageprocess]$ 
```


## 与springboot集成
springboot提供服务，通过ImageMagick工具即可完成处理，处理完成后，将图片上传至阿里云OSS,最后更新数据库。
SO EASY.

## 代码见github
   (https://github.com/njkfei/imageprocess/)[https://github.com/njkfei/imageprocess/]

## 参考
（http://www.imagemagick.com.cn/)[http://www.imagemagick.com.cn/]