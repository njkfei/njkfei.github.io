title: 服务化－API网关
date: 2016.03.11
categories: 服务 #分类
tags: [架构 ]
---
  
## 1　背景
　假设你正在使用微服务的模式构建一个在线商城，并且你正在实现产品的详情页面，你需要开发多个版本的产品详情页面用户接口，如下所示．
* 对于桌面应用或移动浏览器，基于HTML5/JS UI提供接口．HTML通过服务端web应用产生．
* 对于原生android或iPhone APP,通过REST APIR提供接口．
　此外，在线商城必须通过REST风格的API向第三方应用提供产品详情页信息．
　产品详情UI将展示很多关于产品的信息．例如[亚马逊](www.z.cn)的详情页通过_POJOS_展示．
* 书的基本信息，例如书名，作者，价格等
* 您的购买历史
* 购买选项
* 购买这本书的用户经常买的其它书本
* 购买这本书的用户经常买的其它类目商品
* 用户浏览商品信息
* 销售榜单
* ......
	因为使用微服务模式，所以在线商城将分解为多个服务．例如：
* 产品信息服务：关于产品的基本信息，如标题，作者等
* 价格服务：产品价格
* 订单服务：订单购买历史
* 库存服务: 商品是否于可售
* 预览服务：客户预览信息
　因此，为了显示商品详情信息，你将访问多个服务，最后汇集所需要的产品信息．
　　


## 2　问题来了
	客户端如何访问这些服务呢？

## 3　现状
* 微服务提供给客户端的粒度经常是不同的．微服务通常提供细粒度的API.这意味着客户端需要与多个微服务进行交互．如前所述，客户端所需要的产品详情信息，需要从多个服务中进行聚合．
* 不同的客户端需要不同的数据，例如桌面端需要的数据，比移动端需要的数据，要更多更丰富．
* 不同类型客户端之间网络性能的差异．例如，移动网络通常与固网相比，速率更低，延时更高．另外，WAN通过比LAN速率要慢，这意味着移动端对网络性能的要求要比服务端web应用更高．服务端web应用可以多次访问服务，而不会影响用户体验，但移动端去并非如此．
* 服务实例的数量和他们的位置（host:port）会经常变化
* 拆分服务将是长期的过程，应对客户端透明

## 4　解决方案
实现一个针对客户端的单一入口API网关，是解决服务化的必经之路．API网关处理客户端的请求．这些请求可以通过简单的代理或路由到具体的服务．API网关暴露不同的API给客户端，例如netfix api网关运行客户端适配代码，从而给不同的客户端提供合适的服务．

API网关同时提供安全服务，例如，验证客户请求的身份是否合法．

	![pics](imgs/arch/service/apigateway/apigateway.jpg)
	
## 5　结论
### 5.1　优势
　使用API网关，将带来如下好处．
* 将客户端与组成应用的众多微服务进行隔离
* 将客户端与服务实例地址进行隔离
* 为每种客户端提供最理想的API
* 减少请求数量．API网关使得客户端仅需要一次访问，就可以从众多的微服务中获取聚合后的数据．提高了用户体验．API网关是移动应用的必经这路．
* 简化业务逻辑变动和升级
### 5.2　缺陷
	当然，API网关有如下缺陷．
* 复杂度增加：API网关需要不断开发，升级，部署和管理．
* 增加响应时间，因为API网关需要多次访问微服务．
* 如何实现API网关？采用可以伸缩的处理高性能负载的事件驱动/响应式方法是最佳方案．例如，在JVM上，基于NIO库的Netty,Spring Reactor等等．Node.JS是另一种方案．